---
- name: Create Ansible Hosts file
  hosts: localhost
  tasks:
    - name: Generate Config Files and Ansible Hosts file
      script: ./create_6300_base_config.py
      args:
        executable: /usr/bin/python3.11

    # pausing to allow a buffer for the ansible hosts file to be generated from the python script
    - name: Pause for 20 Seconds
      pause:
        seconds: 20

- name: Push Base_Config to the Switches on the PROV_NET based off the CSV file info
  hosts: PROV_NET
  collections:
    - arubanetworks.aoscx
  gather_facts: no

  vars:
    - ansible_user: admin
    - ansible_password: admin
  
  
  tasks:
    ### I had issues sending the config in this method, so the un-commented method was used ###
    # - name: Send Base Config to the Device
    #   aoscx_config:
    #     src: "{{ hostvars[inventory_hostname]['config_file'] }}"
    - name: Read Commands From File
      shell: cat "{{ hostvars[inventory_hostname]['config_file'] }}" # the config file is stored in the hosts file, generated by the python script
      register: config_file
    
    # send the base config fron the config file line by line to the switch
    - name: Send Base Config
      aoscx_command:
        commands: "{{ config_file.stdout_lines }}"


    # I had no consistent results sending a crypto key cert using the aoscx_config module, so I sent it line by line here with an "auto-confirm" flag
    - name: Send Crypto Key Cert 
      vars:
        - ansible_command_timeout: 60
      aoscx_command:
        commands:
          - auto-confirm
          - conf t
          - crypto pki ta-profile wcp-root
          - ta-certificate
          - -----BEGIN CERTIFICATE-----
          - {{}}
          - END_OF_CERTIFICATE

    # copy the running config from the device to validate before writing to memory
    - name: Copy Run Config from the Device
      aoscx_config:
        backup: True
        backup_options:
          filename: "{{ inventory_hostname }}_base_config.aos"
          dir_path: ./applied_configs/
        #save_when: changed
